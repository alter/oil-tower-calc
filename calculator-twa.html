<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oil Clash Calculator</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0e17;
            color: #c8d6e5;
            min-height: 100vh;
            padding: 0;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: #111827;
            min-height: 100vh;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(180deg, #0f1923 0%, #111827 100%);
            border-bottom: 2px solid #00e5ff;
            color: #e0e0e0;
            padding: 12px 15px 15px;
            padding-top: calc(12px + env(safe-area-inset-top));
            text-align: center;
            position: relative;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00e5ff, transparent);
        }

        .header h1 {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #ffffff;
            text-shadow: 0 0 20px rgba(0, 229, 255, 0.3);
            margin-top: 4px;
        }

        .timer {
            font-size: 22px;
            font-weight: 700;
            margin-top: 4px;
            font-family: 'Menlo', 'Courier New', monospace;
            color: #00e5ff;
            text-shadow: 0 0 10px rgba(0, 229, 255, 0.5);
        }

        .lang-switch {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-bottom: 8px;
        }

        .lang-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid #2a3545;
            border-radius: 3px;
            color: #5a6577;
            font-family: -apple-system, sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 32px;
        }

        .lang-btn.active {
            border-color: #00e5ff;
            color: #00e5ff;
            background: rgba(0, 229, 255, 0.1);
        }

        .content {
            padding: 16px;
            padding-left: calc(16px + env(safe-area-inset-left));
            padding-right: calc(16px + env(safe-area-inset-right));
            padding-bottom: calc(16px + env(safe-area-inset-bottom));
        }

        .section { margin-bottom: 20px; }

        .section h2 {
            color: #00e5ff;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid #1e2a3a;
        }

        .form-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-block { display: flex; flex-direction: column; }

        .input-block label {
            font-weight: 600;
            color: #8892a4;
            margin-bottom: 4px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-block input, .input-block select {
            padding: 10px;
            background: #0a0e17;
            border: 1px solid #2a3545;
            border-radius: 6px;
            font-size: 16px;
            font-family: 'Menlo', 'Courier New', monospace;
            color: #e0e0e0;
            transition: border-color 0.2s, box-shadow 0.2s;
            min-height: 44px;
        }

        .input-block input[type="number"] {
            width: calc(6ch + 22px);
        }

        .input-block input:focus, .input-block select:focus {
            outline: none;
            border-color: #00e5ff;
            box-shadow: 0 0 8px rgba(0, 229, 255, 0.15);
        }

        .tower-config {
            background: #0d1320;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #1e2a3a;
        }

        .tower-item {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
            padding: 10px;
            background: #111827;
            border-radius: 4px;
            border-left: 3px solid #00e5ff;
        }

        .tower-item:last-child { margin-bottom: 0; }

        .tower-item h4 {
            color: #00e5ff;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            grid-column: 1 / -1;
            margin-bottom: 2px;
        }

        .team-select { display: flex; flex-direction: column; }

        .team-select label {
            font-weight: 600;
            color: #8892a4;
            margin-bottom: 4px;
            font-size: 11px;
            text-transform: uppercase;
        }

        .team-select select {
            padding: 10px;
            background: #0a0e17;
            border: 1px solid #2a3545;
            border-radius: 6px;
            font-size: 16px;
            font-family: -apple-system, sans-serif;
            color: #e0e0e0;
            min-height: 44px;
        }

        .team-select select:focus { outline: none; border-color: #00e5ff; }

        .verdict {
            margin-top: 12px;
            padding: 14px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            line-height: 1.5;
        }

        .verdict.win { background: rgba(0,255,136,0.1); border: 1px solid #00ff88; color: #00ff88; }
        .verdict.lose { background: rgba(255,55,95,0.1); border: 1px solid #ff375f; color: #ff375f; }
        .verdict.need-action { background: rgba(255,170,0,0.1); border: 1px solid #ffaa00; color: #ffaa00; }

        .info-card {
            background: #0a0e17;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #2a3545;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .info-card .label { margin-bottom: 0; color: #5a6577; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .info-card .value { font-size: 15px; font-weight: 700; font-family: 'Menlo', 'Courier New', monospace; color: #00e5ff; }

        .optimize-btn {
            width: 100%;
            padding: 14px;
            background: transparent;
            color: #00e5ff;
            border: 1px solid #00e5ff;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            font-family: -apple-system, sans-serif;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 48px;
        }

        .optimize-btn:hover, .optimize-btn:active {
            background: rgba(0,229,255,0.1);
            box-shadow: 0 0 15px rgba(0,229,255,0.2);
        }

        .cranes-select {
            padding: 8px 10px;
            background: #0a0e17;
            border: 1px solid #2a3545;
            border-radius: 6px;
            font-size: 16px;
            color: #e0e0e0;
            font-family: 'Menlo', 'Courier New', monospace;
            min-height: 44px;
        }

        /* iPhone 13/14/15 and similar (viewport <= 414px) */
        @media (max-width: 414px) {
            .tower-item {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }

        /* Small screens (iPhone SE, etc) */
        @media (max-width: 374px) {
            .form-group { grid-template-columns: 1fr; }
            .header h1 { font-size: 15px; }
            .timer { font-size: 18px; }
            .lang-btn { padding: 5px 8px; font-size: 12px; }
        }

        /* Desktop (unlikely in Telegram but just in case) */
        @media (min-width: 769px) {
            body { padding: 20px; }
            .container {
                max-width: 1200px;
                border-radius: 8px;
                border: 1px solid #1e2a3a;
                box-shadow: 0 0 40px rgba(0, 200, 255, 0.05);
                min-height: auto;
            }
            .header { padding: 25px 30px; }
            .header h1 { font-size: 26px; letter-spacing: 2px; }
            .timer { font-size: 28px; margin-top: 8px; }
            .content { padding: 25px; }
            .section { margin-bottom: 30px; }
            .section h2 { font-size: 18px; margin-bottom: 15px; padding-bottom: 8px; }
            .form-group { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 15px; }
            .input-block label { font-size: 13px; margin-bottom: 6px; }
            .tower-config { padding: 15px; }
            .tower-item { grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; margin-bottom: 10px; }
            .tower-item h4 { font-size: 13px; margin-bottom: 4px; }
            .optimize-btn { width: auto; padding: 10px 24px; font-size: 15px; }
            .verdict { padding: 16px; font-size: 15px; margin-top: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="lang-switch">
                <button class="lang-btn active" data-lang="ru">RU</button>
                <button class="lang-btn" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="de">DE</button>
                <button class="lang-btn" data-lang="fr">FR</button>
                <button class="lang-btn" data-lang="es">ES</button>
            </div>
            <h1 data-i18n="title">–ë–∏—Ç–≤–∞ –∑–∞ –Ω–µ—Ñ—Ç—å ‚Äî –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h1>
            <div class="timer" id="timer">00:00:00</div>
        </div>

        <div class="content">
            <div class="section">
                <h2 data-i18n="sectionPoints">üìä –¢–µ–∫—É—â–∏–µ –æ—á–∫–∏ –∫–æ–º–∞–Ω–¥</h2>
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: 600; color: #8892a4; font-size: 13px; margin-right: 10px; text-transform: uppercase; letter-spacing: 0.5px;" data-i18n="teamsCountLabel">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥:</label>
                    <select id="teamsCount" class="cranes-select">
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="input-block" style="border-left: 3px solid #00ff88; padding-left: 10px;">
                        <label data-i18n="team1Label" style="color: #00ff88;">–ú–æ—è –∫–æ–º–∞–Ω–¥–∞</label>
                        <input type="number" id="points1" value="0" min="0" style="border-color: #00ff88;">
                    </div>
                    <div class="input-block" id="teamBlock2">
                        <label data-i18n="team2Label">–ö–æ–º–∞–Ω–¥–∞ 2</label>
                        <input type="number" id="points2" value="0" min="0">
                    </div>
                    <div class="input-block" id="teamBlock3">
                        <label data-i18n="team3Label">–ö–æ–º–∞–Ω–¥–∞ 3</label>
                        <input type="number" id="points3" value="0" min="0">
                    </div>
                    <div class="input-block" id="teamBlock4">
                        <label data-i18n="team4Label">–ö–æ–º–∞–Ω–¥–∞ 4</label>
                        <input type="number" id="points4" value="0" min="0">
                    </div>
                    <div class="input-block" id="teamBlock5">
                        <label data-i18n="team5Label">–ö–æ–º–∞–Ω–¥–∞ 5</label>
                        <input type="number" id="points5" value="0" min="0">
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 data-i18n="sectionTower">üèóÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–∞—à–Ω–∏</h2>
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: 600; color: #8892a4; font-size: 13px; margin-right: 10px; text-transform: uppercase; letter-spacing: 0.5px;" data-i18n="cranesCountLabel">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—Ä–∞–Ω–æ–≤:</label>
                    <select id="cranesCount" class="cranes-select">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                </div>
                <div class="tower-config">
                    <div class="tower-item">
                        <h4 data-i18n="centerTower">üéØ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –±–∞—à–Ω—è</h4>
                        <div class="team-select">
                            <label data-i18n="teamSelectLabel">–ö–æ–º–∞–Ω–¥–∞</label>
                            <select id="middle" class="team-option-select">
                                <option value="">-- –ü—É—Å—Ç–æ --</option>
                                <option value="1">–ú–æ—è –∫–æ–º–∞–Ω–¥–∞</option>
                                <option value="2">–ö–æ–º–∞–Ω–¥–∞ 2</option>
                            </select>
                        </div>
                        <div class="info-card">
                            <div class="label" data-i18n="ptsPerMin">–û—á–∫–æ–≤ –≤ –º–∏–Ω—É—Ç—É</div>
                            <div class="value">6</div>
                        </div>
                    </div>

                    <div class="tower-item" id="craneItem1">
                        <h4>üèóÔ∏è <span data-i18n="crane">–ö—Ä–∞–Ω</span> 1</h4>
                        <div class="team-select">
                            <label data-i18n="teamSelectLabel">–ö–æ–º–∞–Ω–¥–∞</label>
                            <select id="crane1" class="team-option-select">
                                <option value="">-- –ü—É—Å—Ç–æ --</option>
                                <option value="1">–ú–æ—è –∫–æ–º–∞–Ω–¥–∞</option>
                                <option value="2">–ö–æ–º–∞–Ω–¥–∞ 2</option>
                            </select>
                        </div>
                        <div class="info-card">
                            <div class="label" data-i18n="ptsPerMin">–û—á–∫–æ–≤ –≤ –º–∏–Ω—É—Ç—É</div>
                            <div class="value">4</div>
                        </div>
                    </div>

                    <div class="tower-item" id="craneItem2">
                        <h4>üèóÔ∏è <span data-i18n="crane">–ö—Ä–∞–Ω</span> 2</h4>
                        <div class="team-select">
                            <label data-i18n="teamSelectLabel">–ö–æ–º–∞–Ω–¥–∞</label>
                            <select id="crane2" class="team-option-select">
                                <option value="">-- –ü—É—Å—Ç–æ --</option>
                                <option value="1">–ú–æ—è –∫–æ–º–∞–Ω–¥–∞</option>
                                <option value="2">–ö–æ–º–∞–Ω–¥–∞ 2</option>
                            </select>
                        </div>
                        <div class="info-card">
                            <div class="label" data-i18n="ptsPerMin">–û—á–∫–æ–≤ –≤ –º–∏–Ω—É—Ç—É</div>
                            <div class="value">4</div>
                        </div>
                    </div>

                    <div class="tower-item" id="craneItem3">
                        <h4>üèóÔ∏è <span data-i18n="crane">–ö—Ä–∞–Ω</span> 3</h4>
                        <div class="team-select">
                            <label data-i18n="teamSelectLabel">–ö–æ–º–∞–Ω–¥–∞</label>
                            <select id="crane3" class="team-option-select">
                                <option value="">-- –ü—É—Å—Ç–æ --</option>
                                <option value="1">–ú–æ—è –∫–æ–º–∞–Ω–¥–∞</option>
                                <option value="2">–ö–æ–º–∞–Ω–¥–∞ 2</option>
                            </select>
                        </div>
                        <div class="info-card">
                            <div class="label" data-i18n="ptsPerMin">–û—á–∫–æ–≤ –≤ –º–∏–Ω—É—Ç—É</div>
                            <div class="value">4</div>
                        </div>
                    </div>

                    <div class="tower-item" id="craneItem4">
                        <h4>üèóÔ∏è <span data-i18n="crane">–ö—Ä–∞–Ω</span> 4</h4>
                        <div class="team-select">
                            <label data-i18n="teamSelectLabel">–ö–æ–º–∞–Ω–¥–∞</label>
                            <select id="crane4" class="team-option-select">
                                <option value="">-- –ü—É—Å—Ç–æ --</option>
                                <option value="1">–ú–æ—è –∫–æ–º–∞–Ω–¥–∞</option>
                                <option value="2">–ö–æ–º–∞–Ω–¥–∞ 2</option>
                            </select>
                        </div>
                        <div class="info-card">
                            <div class="label" data-i18n="ptsPerMin">–û—á–∫–æ–≤ –≤ –º–∏–Ω—É—Ç—É</div>
                            <div class="value">4</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 data-i18n="sectionForecast">üìà –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –∫–æ–Ω–µ—Ü –¥–Ω—è (UTC)</h2>
                <button id="optimizeBtn" class="optimize-btn" data-i18n="findStrategy">üîç –ù–∞–π—Ç–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é</button>
                <div id="recommendation" style="background: #0d1320; border-radius: 6px; padding: 16px; border-left: 3px solid #00e5ff; margin-bottom: 15px; margin-top: 15px; border: 1px solid #1e2a3a;">
                    <p style="color: #5a6577; margin: 0; font-size: 14px;" data-i18n="clickToFind">–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</p>
                </div>
                <div id="verdict"></div>
            </div>
        </div>
    </div>

    <script>
        // ==================== Telegram Web App ====================
        const tg = Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Disable vertical swipe to close (prevents accidental close while scrolling)
        if (tg.isVerticalSwipesEnabled !== undefined) {
            tg.disableVerticalSwipes();
        }

        // Auto-detect language from Telegram user profile
        const tgLangMap = { ru: 'ru', en: 'en', de: 'de', fr: 'fr', es: 'es' };
        let detectedLang = 'ru';
        try {
            const userLang = tg.initDataUnsafe?.user?.language_code;
            if (userLang && tgLangMap[userLang]) {
                detectedLang = tgLangMap[userLang];
            } else if (userLang && userLang.startsWith('en')) {
                detectedLang = 'en';
            }
        } catch(e) {}

        // ==================== i18n ====================
        const LANGS = {
            ru: {
                title: '–ë–∏—Ç–≤–∞ –∑–∞ –Ω–µ—Ñ—Ç—å ‚Äî –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä',
                sectionPoints: 'üìä –¢–µ–∫—É—â–∏–µ –æ—á–∫–∏ –∫–æ–º–∞–Ω–¥',
                sectionTower: 'üèóÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–∞—à–Ω–∏',
                sectionRecommendation: 'üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è',
                sectionForecast: 'üìà –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –∫–æ–Ω–µ—Ü –¥–Ω—è (UTC)',
                team1Label: '–ú–æ—è –∫–æ–º–∞–Ω–¥–∞',
                team2Label: '–ö–æ–º–∞–Ω–¥–∞ 2',
                team3Label: '–ö–æ–º–∞–Ω–¥–∞ 3',
                team4Label: '–ö–æ–º–∞–Ω–¥–∞ 4',
                team5Label: '–ö–æ–º–∞–Ω–¥–∞ 5',
                cranesCountLabel: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—Ä–∞–Ω–æ–≤:',
                centerTower: 'üéØ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –±–∞—à–Ω—è',
                crane: '–ö—Ä–∞–Ω',
                teamSelectLabel: '–ö–æ–º–∞–Ω–¥–∞',
                ptsPerMin: '–û—á–∫–æ–≤ –≤ –º–∏–Ω—É—Ç—É',
                clickToFind: '–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏',
                findStrategy: 'üîç –ù–∞–π—Ç–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é',
                searching: '‚è≥ –ò—â—É...',
                emptyOption: '-- –ü—É—Å—Ç–æ --',
                teamN: '–ö–æ–º–∞–Ω–¥–∞',
                myTeam: '–ú–æ—è –∫–æ–º–∞–Ω–¥–∞',
                center: '–¶–µ–Ω—Ç—Ä',
                craneN: '–ö—Ä–∞–Ω',
                current: '—Å–µ–π—á–∞—Å',
                min: '–º–∏–Ω',
                pts: '–æ—á–∫–æ–≤',
                teamsCountLabel: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥:',
                noActive: '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–∞–Ω–¥',
                alreadyWin: (T) => `‚úÖ –£–∂–µ –ø–æ–±–µ–∂–¥–∞–µ—à—å! –î–∞–∂–µ –µ—Å–ª–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫ –∑–∞–±–µ—Ä—ë—Ç –≤—Å–µ ${T} –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –æ—á–∫–æ–≤ ‚Äî —Ç—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –≤–ø–µ—Ä–µ–¥–∏.`,
                impossible: (T, need, deficit) => `‚ùå –ü–æ–±–µ–¥–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞. –ù–∞ –±–∞—à–Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å ${T} –æ—á–∫–æ–≤, –∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–æ–±–µ–¥—ã –Ω—É–∂–Ω–æ –∑–∞–±—Ä–∞—Ç—å ${need}.<div style="font-size:14px;margin-top:8px;">–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç ${deficit} –æ—á–∫–æ–≤ ‚Äî –Ω–µ–æ—Ç–∫—É–¥–∞ –≤–∑—è—Ç—å.</div>`,
                needCapture: (need, T, pct, rate, hint) => `‚ö†Ô∏è –î–ª—è –ø–æ–±–µ–¥—ã –Ω—É–∂–Ω–æ –∑–∞—Ö–≤–∞—Ç–∏—Ç—å <strong>${need}</strong> –∏–∑ ${T} –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –æ—á–∫–æ–≤ (${pct}%), –ø–æ—Ç–æ–º—É —á—Ç–æ –æ—Å—Ç–∞–ª—å–Ω–æ–µ –∑–∞–±–µ—Ä—ë—Ç —Å–æ–ø–µ—Ä–Ω–∏–∫<div style="font-size:14px;margin-top:8px;">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å: <strong>${rate}/–º–∏–Ω</strong> ‚Üí ${hint}</div>`,
                hintCrane: (r) => `–•–≤–∞—Ç–∏—Ç –æ–¥–Ω–æ–≥–æ –∫—Ä–∞–Ω–∞ (${r}/–º–∏–Ω)`,
                hintCenter: (cr, mr) => `–ù—É–∂–µ–Ω –º–∏–Ω–∏–º—É–º —Ü–µ–Ω—Ç—Ä (${mr}/–º–∏–Ω), –æ–¥–Ω–æ–≥–æ –∫—Ä–∞–Ω–∞ (${cr}/–º–∏–Ω) –º–∞–ª–æ`,
                hintCenterCrane: (r) => `–ù—É–∂–µ–Ω —Ü–µ–Ω—Ç—Ä + –∫—Ä–∞–Ω (${r}/–º–∏–Ω)`,
                hintMulti: (r) => `–ù—É–∂–Ω–æ ${r}/–º–∏–Ω ‚Äî –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–π`,
                noWin: (T) => `<div style="font-size:16px;font-weight:bold;color:#ff375f;">‚ùå –ü–û–ë–ï–î–ê –ù–ï–í–û–ó–ú–û–ñ–ù–ê</div><div style="margin-top:10px;color:#c8d6e5;font-size:14px;">–î–∞–∂–µ –µ—Å–ª–∏ –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏ ‚Äî –≤—Å–µ–≥–æ –º–æ–∂–Ω–æ –Ω–∞–±—Ä–∞—Ç—å ${T} –æ—á–∫–æ–≤. –≠—Ç–æ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∏—Ç.</div><div style="margin-top:8px;color:#5a6577;font-size:13px;">–ù–µ —Ç—Ä–∞—Ç—å—Ç–µ –ø–æ–ø—ã—Ç–∫–∏ –Ω–∞ —ç—Ç—É –±–∞—à–Ω—é.</div>`,
                winsTitle: 'üìç –í–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è –ø–æ–±–µ–¥—ã',
                stratDoNothing: 'üòé –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–π ‚Äî —É–∂–µ –ø–æ–±–µ–¥–∏—à—å!',
                stratCenter: 'üéØ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ—Ä–∂–∞—Ç—å <strong>–¶–ï–ù–¢–†</strong>',
                stratOneCrane: 'üèóÔ∏è –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ—Ä–∂–∞—Ç—å <strong>–û–î–ò–ù –ö–†–ê–ù</strong>',
                stratCranes: (n) => `üèóÔ∏è –î–µ—Ä–∂–∏ <strong>${n} ${n === 1 ? '–ö–†–ê–ù' : '–ö–†–ê–ù–ê'}</strong> ‚Äî —Ü–µ–Ω—Ç—Ä –Ω–µ –Ω—É–∂–µ–Ω`,
                stratCenterCranes: (n) => `üéØ –î–µ—Ä–∂–∏ <strong>–¶–ï–ù–¢–†</strong> –∏ <strong>${n} ${n === 1 ? '–ö–†–ê–ù' : '–ö–†–ê–ù–ê'}</strong>`,
                noPositions: '–Ω–µ—Ç –ø–æ–∑–∏—Ü–∏–π',
                enemies: '–í—Ä–∞–≥–∏',
            },
            en: {
                title: 'Oil Clash ‚Äî Calculator',
                sectionPoints: 'üìä Current Team Points',
                sectionTower: 'üèóÔ∏è Tower Configuration',
                sectionRecommendation: 'üí° Recommendation',
                sectionForecast: 'üìà End of Day Forecast (UTC)',
                team1Label: 'My Team',
                team2Label: 'Team 2',
                team3Label: 'Team 3',
                team4Label: 'Team 4',
                team5Label: 'Team 5',
                cranesCountLabel: 'Number of cranes:',
                centerTower: 'üéØ Center Tower',
                crane: 'Crane',
                teamSelectLabel: 'Team',
                ptsPerMin: 'Points per minute',
                clickToFind: 'Click button to find optimal strategy',
                findStrategy: 'üîç Find Strategy',
                searching: '‚è≥ Searching...',
                emptyOption: '-- Empty --',
                teamN: 'Team',
                myTeam: 'My Team',
                center: 'Center',
                craneN: 'Crane',
                current: 'current',
                min: 'min',
                pts: 'pts',
                teamsCountLabel: 'Number of teams:',
                noActive: 'No active teams',
                alreadyWin: (T) => `‚úÖ Already winning! Even if opponent takes all ${T} remaining points ‚Äî you're still ahead.`,
                impossible: (T, need, deficit) => `‚ùå Victory impossible. Tower has ${T} points left, but you need ${need} to guarantee a win.<div style="font-size:14px;margin-top:8px;">Short by ${deficit} points ‚Äî nowhere to get them.</div>`,
                needCapture: (need, T, pct, rate, hint) => `‚ö†Ô∏è To win, capture <strong>${need}</strong> of ${T} remaining points (${pct}%) ‚Äî the rest will go to the opponent<div style="font-size:14px;margin-top:8px;">Minimum rate: <strong>${rate}/min</strong> ‚Üí ${hint}</div>`,
                hintCrane: (r) => `One crane is enough (${r}/min)`,
                hintCenter: (cr, mr) => `Need at least center (${mr}/min), one crane (${cr}/min) not enough`,
                hintCenterCrane: (r) => `Need center + crane (${r}/min)`,
                hintMulti: (r) => `Need ${r}/min ‚Äî multiple positions`,
                noWin: (T) => `<div style="font-size:16px;font-weight:bold;color:#ff375f;">‚ùå VICTORY IMPOSSIBLE</div><div style="margin-top:10px;color:#c8d6e5;font-size:14px;">Even capturing all points ‚Äî only ${T} available. Not enough to overtake.</div><div style="margin-top:8px;color:#5a6577;font-size:13px;">Don't waste attempts on this tower.</div>`,
                winsTitle: 'üìç Winning Options',
                stratDoNothing: 'üòé Do nothing ‚Äî already winning!',
                stratCenter: 'üéØ Just hold <strong>CENTER</strong>',
                stratOneCrane: 'üèóÔ∏è Just hold <strong>ONE CRANE</strong>',
                stratCranes: (n) => `üèóÔ∏è Hold <strong>${n} CRANE${n > 1 ? 'S' : ''}</strong> ‚Äî center not needed`,
                stratCenterCranes: (n) => `üéØ Hold <strong>CENTER</strong> and <strong>${n} CRANE${n > 1 ? 'S' : ''}</strong>`,
                noPositions: 'no positions',
                enemies: 'Enemies',
            },
            de: {
                title: '√ñlkrieg ‚Äî Rechner',
                sectionPoints: 'üìä Aktuelle Teampunkte',
                sectionTower: 'üèóÔ∏è Turmkonfiguration',
                sectionRecommendation: 'üí° Empfehlung',
                sectionForecast: 'üìà Tagesprognose (UTC)',
                team1Label: 'Mein Team',
                team2Label: 'Team 2',
                team3Label: 'Team 3',
                team4Label: 'Team 4',
                team5Label: 'Team 5',
                cranesCountLabel: 'Anzahl der Kr√§ne:',
                centerTower: 'üéØ Zentralturm',
                crane: 'Kran',
                teamSelectLabel: 'Team',
                ptsPerMin: 'Punkte pro Minute',
                clickToFind: 'Klicke, um die optimale Strategie zu finden',
                findStrategy: 'üîç Strategie finden',
                searching: '‚è≥ Suche...',
                emptyOption: '-- Leer --',
                teamN: 'Team',
                myTeam: 'Mein Team',
                center: 'Zentrum',
                craneN: 'Kran',
                current: 'aktuell',
                min: 'Min',
                pts: 'Pkt',
                teamsCountLabel: 'Anzahl der Teams:',
                noActive: 'Keine aktiven Teams',
                alreadyWin: (T) => `‚úÖ Du gewinnst bereits! Selbst wenn der Gegner alle ${T} verbleibenden Punkte nimmt ‚Äî du bleibst vorne.`,
                impossible: (T, need, deficit) => `‚ùå Sieg unm√∂glich. Auf dem Turm bleiben ${T} Punkte, aber du brauchst ${need} f√ºr einen garantierten Sieg.<div style="font-size:14px;margin-top:8px;">Es fehlen ${deficit} Punkte ‚Äî unerreichbar.</div>`,
                needCapture: (need, T, pct, rate, hint) => `‚ö†Ô∏è Zum Sieg musst du <strong>${need}</strong> von ${T} verbleibenden Punkten erobern (${pct}%) ‚Äî den Rest nimmt der Gegner<div style="font-size:14px;margin-top:8px;">Mindestrate: <strong>${rate}/Min</strong> ‚Üí ${hint}</div>`,
                hintCrane: (r) => `Ein Kran reicht (${r}/Min)`,
                hintCenter: (cr, mr) => `Mindestens Zentrum n√∂tig (${mr}/Min), ein Kran (${cr}/Min) reicht nicht`,
                hintCenterCrane: (r) => `Zentrum + Kran n√∂tig (${r}/Min)`,
                hintMulti: (r) => `${r}/Min n√∂tig ‚Äî mehrere Positionen`,
                noWin: (T) => `<div style="font-size:16px;font-weight:bold;color:#ff375f;">‚ùå SIEG UNM√ñGLICH</div><div style="margin-top:10px;color:#c8d6e5;font-size:14px;">Selbst bei Eroberung aller Punkte ‚Äî nur ${T} verf√ºgbar. Nicht genug.</div><div style="margin-top:8px;color:#5a6577;font-size:13px;">Verschwende keine Versuche an diesem Turm.</div>`,
                winsTitle: 'üìç Siegoptionen',
                stratDoNothing: 'üòé Nichts tun ‚Äî du gewinnst bereits!',
                stratCenter: 'üéØ Es reicht, das <strong>ZENTRUM</strong> zu halten',
                stratOneCrane: 'üèóÔ∏è Es reicht, <strong>EINEN KRAN</strong> zu halten',
                stratCranes: (n) => `üèóÔ∏è Halte <strong>${n} KRAN${n > 1 ? 'E' : ''}</strong> ‚Äî Zentrum nicht n√∂tig`,
                stratCenterCranes: (n) => `üéØ Halte <strong>ZENTRUM</strong> und <strong>${n} KRAN${n > 1 ? 'E' : ''}</strong>`,
                noPositions: 'keine Positionen',
                enemies: 'Gegner',
            },
            fr: {
                title: 'Guerre du p√©trole ‚Äî Calculateur',
                sectionPoints: 'üìä Points actuels des √©quipes',
                sectionTower: 'üèóÔ∏è Configuration de la tour',
                sectionRecommendation: 'üí° Recommandation',
                sectionForecast: 'üìà Pr√©vision fin de journ√©e (UTC)',
                team1Label: 'Mon √©quipe',
                team2Label: '√âquipe 2',
                team3Label: '√âquipe 3',
                team4Label: '√âquipe 4',
                team5Label: '√âquipe 5',
                cranesCountLabel: 'Nombre de grues :',
                centerTower: 'üéØ Tour centrale',
                crane: 'Grue',
                teamSelectLabel: '√âquipe',
                ptsPerMin: 'Points par minute',
                clickToFind: 'Cliquez pour trouver la strat√©gie optimale',
                findStrategy: 'üîç Trouver une strat√©gie',
                searching: '‚è≥ Recherche...',
                emptyOption: '-- Vide --',
                teamN: '√âquipe',
                myTeam: 'Mon √©quipe',
                center: 'Centre',
                craneN: 'Grue',
                current: 'actuel',
                min: 'min',
                pts: 'pts',
                teamsCountLabel: "Nombre d'√©quipes :",
                noActive: "Aucune √©quipe active",
                alreadyWin: (T) => `‚úÖ D√©j√† en t√™te ! M√™me si l'adversaire prend les ${T} points restants ‚Äî vous gardez l'avantage.`,
                impossible: (T, need, deficit) => `‚ùå Victoire impossible. Il reste ${T} points sur la tour, mais il en faut ${need} pour garantir la victoire.<div style="font-size:14px;margin-top:8px;">Il manque ${deficit} points ‚Äî impossible √† obtenir.</div>`,
                needCapture: (need, T, pct, rate, hint) => `‚ö†Ô∏è Pour gagner, capturez <strong>${need}</strong> des ${T} points restants (${pct}%) ‚Äî le reste ira √† l'adversaire<div style="font-size:14px;margin-top:8px;">D√©bit minimum : <strong>${rate}/min</strong> ‚Üí ${hint}</div>`,
                hintCrane: (r) => `Une grue suffit (${r}/min)`,
                hintCenter: (cr, mr) => `Le centre est n√©cessaire (${mr}/min), une grue (${cr}/min) ne suffit pas`,
                hintCenterCrane: (r) => `Centre + grue n√©cessaire (${r}/min)`,
                hintMulti: (r) => `${r}/min n√©cessaire ‚Äî plusieurs positions`,
                noWin: (T) => `<div style="font-size:16px;font-weight:bold;color:#ff375f;">‚ùå VICTOIRE IMPOSSIBLE</div><div style="margin-top:10px;color:#c8d6e5;font-size:14px;">M√™me en capturant tous les points ‚Äî seulement ${T} disponibles. Pas assez.</div><div style="margin-top:8px;color:#5a6577;font-size:13px;">Ne gaspillez pas vos tentatives sur cette tour.</div>`,
                winsTitle: 'üìç Options de victoire',
                stratDoNothing: 'üòé Ne rien faire ‚Äî vous gagnez d√©j√† !',
                stratCenter: 'üéØ Il suffit de tenir le <strong>CENTRE</strong>',
                stratOneCrane: 'üèóÔ∏è Il suffit de tenir <strong>UNE GRUE</strong>',
                stratCranes: (n) => `üèóÔ∏è Tenez <strong>${n} GRUE${n > 1 ? 'S' : ''}</strong> ‚Äî centre pas n√©cessaire`,
                stratCenterCranes: (n) => `üéØ Tenez le <strong>CENTRE</strong> et <strong>${n} GRUE${n > 1 ? 'S' : ''}</strong>`,
                noPositions: 'aucune position',
                enemies: 'Ennemis',
            },
            es: {
                title: 'Guerra del petr√≥leo ‚Äî Calculadora',
                sectionPoints: 'üìä Puntos actuales de equipos',
                sectionTower: 'üèóÔ∏è Configuraci√≥n de la torre',
                sectionRecommendation: 'üí° Recomendaci√≥n',
                sectionForecast: 'üìà Pron√≥stico de fin de d√≠a (UTC)',
                team1Label: 'Mi equipo',
                team2Label: 'Equipo 2',
                team3Label: 'Equipo 3',
                team4Label: 'Equipo 4',
                team5Label: 'Equipo 5',
                cranesCountLabel: 'N√∫mero de gr√∫as:',
                centerTower: 'üéØ Torre central',
                crane: 'Gr√∫a',
                teamSelectLabel: 'Equipo',
                ptsPerMin: 'Puntos por minuto',
                clickToFind: 'Pulsa para encontrar la estrategia √≥ptima',
                findStrategy: 'üîç Buscar estrategia',
                searching: '‚è≥ Buscando...',
                emptyOption: '-- Vac√≠o --',
                teamN: 'Equipo',
                myTeam: 'Mi equipo',
                center: 'Centro',
                craneN: 'Gr√∫a',
                current: 'actual',
                min: 'min',
                pts: 'pts',
                teamsCountLabel: 'N√∫mero de equipos:',
                noActive: 'Sin equipos activos',
                alreadyWin: (T) => `‚úÖ ¬°Ya vas ganando! Aunque el rival tome los ${T} puntos restantes ‚Äî sigues adelante.`,
                impossible: (T, need, deficit) => `‚ùå Victoria imposible. Quedan ${T} puntos en la torre, pero necesitas ${need} para ganar.<div style="font-size:14px;margin-top:8px;">Faltan ${deficit} puntos ‚Äî no hay de d√≥nde sacarlos.</div>`,
                needCapture: (need, T, pct, rate, hint) => `‚ö†Ô∏è Para ganar, captura <strong>${need}</strong> de ${T} puntos restantes (${pct}%) ‚Äî el resto lo tomar√° el rival<div style="font-size:14px;margin-top:8px;">Velocidad m√≠nima: <strong>${rate}/min</strong> ‚Üí ${hint}</div>`,
                hintCrane: (r) => `Una gr√∫a es suficiente (${r}/min)`,
                hintCenter: (cr, mr) => `Se necesita el centro (${mr}/min), una gr√∫a (${cr}/min) no basta`,
                hintCenterCrane: (r) => `Se necesita centro + gr√∫a (${r}/min)`,
                hintMulti: (r) => `Se necesita ${r}/min ‚Äî varias posiciones`,
                noWin: (T) => `<div style="font-size:16px;font-weight:bold;color:#ff375f;">‚ùå VICTORIA IMPOSIBLE</div><div style="margin-top:10px;color:#c8d6e5;font-size:14px;">Incluso capturando todo ‚Äî solo ${T} puntos disponibles. No es suficiente.</div><div style="margin-top:8px;color:#5a6577;font-size:13px;">No gastes intentos en esta torre.</div>`,
                winsTitle: 'üìç Opciones de victoria',
                stratDoNothing: 'üòé ¬°No hagas nada ‚Äî ya est√°s ganando!',
                stratCenter: 'üéØ Basta con mantener el <strong>CENTRO</strong>',
                stratOneCrane: 'üèóÔ∏è Basta con mantener <strong>UNA GR√öA</strong>',
                stratCranes: (n) => `üèóÔ∏è Mant√©n <strong>${n} GR√öA${n > 1 ? 'S' : ''}</strong> ‚Äî centro no necesario`,
                stratCenterCranes: (n) => `üéØ Mant√©n el <strong>CENTRO</strong> y <strong>${n} GR√öA${n > 1 ? 'S' : ''}</strong>`,
                noPositions: 'sin posiciones',
                enemies: 'Enemigos',
            }
        };

        let lang = 'ru';
        let L = LANGS[lang];

        function t(key) { return L[key] || key; }

        function setLang(newLang) {
            lang = newLang;
            L = LANGS[lang];
            document.querySelectorAll('.lang-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.lang === lang);
            });
            // Update static elements
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (L[key] && typeof L[key] === 'string') {
                    el.textContent = L[key];
                }
            });
            // Update select options
            updateSelectOptions();
            // Re-run calculations to update dynamic text
            calculate();
            // Re-run optimizer so recommendation text updates too
            document.getElementById('optimizeBtn').click();
        }

        function updateSelectOptions() {
            const teamCount = getActiveTeamsCount();
            document.querySelectorAll('.team-option-select').forEach(sel => {
                const currentVal = sel.value;
                sel.innerHTML = `<option value="">${t('emptyOption')}</option>`;
                for (let i = 1; i <= teamCount; i++) {
                    const name = i === 1 ? t('myTeam') : `${t('teamN')} ${i}`;
                    sel.innerHTML += `<option value="${i}">${name}</option>`;
                }
                // Reset if selected team is no longer active
                if (parseInt(currentVal) > teamCount) {
                    sel.value = '';
                } else {
                    sel.value = currentVal;
                }
            });
        }

        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', () => setLang(btn.dataset.lang));
        });

        // ==================== Constants & Elements ====================
        const TOWER_MIDDLE_RATE = 6;
        const CRANE_RATE = 4;

        const pointsInputs = {
            1: document.getElementById('points1'),
            2: document.getElementById('points2'),
            3: document.getElementById('points3'),
            4: document.getElementById('points4'),
            5: document.getElementById('points5')
        };

        const towerSelects = {
            middle: document.getElementById('middle'),
            crane1: document.getElementById('crane1'),
            crane2: document.getElementById('crane2'),
            crane3: document.getElementById('crane3'),
            crane4: document.getElementById('crane4')
        };

        const teamsCountSelect = document.getElementById('teamsCount');
        const teamBlocks = {
            2: document.getElementById('teamBlock2'),
            3: document.getElementById('teamBlock3'),
            4: document.getElementById('teamBlock4'),
            5: document.getElementById('teamBlock5')
        };

        function getActiveTeamsCount() {
            return parseInt(teamsCountSelect.value);
        }

        function updateTeamVisibility() {
            const count = getActiveTeamsCount();
            for (let i = 2; i <= 5; i++) {
                teamBlocks[i].style.display = i <= count ? '' : 'none';
                if (i > count) pointsInputs[i].value = 0;
            }
            updateSelectOptions();
            calculate();
        }

        teamsCountSelect.addEventListener('change', updateTeamVisibility);

        const cranesCountSelect = document.getElementById('cranesCount');
        const craneItems = {
            1: document.getElementById('craneItem1'),
            2: document.getElementById('craneItem2'),
            3: document.getElementById('craneItem3'),
            4: document.getElementById('craneItem4')
        };

        function getActiveCranesCount() {
            return parseInt(cranesCountSelect.value);
        }

        function updateCraneVisibility() {
            const count = getActiveCranesCount();
            for (let i = 1; i <= 4; i++) {
                craneItems[i].style.display = i <= count ? '' : 'none';
                if (i > count) towerSelects[`crane${i}`].value = '';
            }
            calculate();
        }

        cranesCountSelect.addEventListener('change', updateCraneVisibility);

        Object.values(pointsInputs).forEach(input => {
            input.addEventListener('change', calculate);
            input.addEventListener('input', calculate);
        });

        Object.values(towerSelects).forEach(select => {
            select.addEventListener('change', calculate);
        });

        setInterval(updateTimer, 1000);

        // ==================== Timer ====================
        function updateTimer() {
            const now = new Date();
            const endOfDay = new Date(now);
            endOfDay.setUTCHours(23, 59, 59, 999);
            const timeLeft = endOfDay - now;
            if (timeLeft <= 0) {
                document.getElementById('timer').textContent = '00:00:00';
                return;
            }
            const h = Math.floor(timeLeft / 3600000);
            const m = Math.floor((timeLeft % 3600000) / 60000);
            const s = Math.floor((timeLeft % 60000) / 1000);
            document.getElementById('timer').textContent =
                `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        function getTimeLeftMinutes() {
            const now = new Date();
            const endOfDay = new Date(now);
            endOfDay.setUTCHours(23, 59, 59, 999);
            return Math.max(0, Math.floor((endOfDay - now) / 60000));
        }

        // ==================== Core Calculation ====================
        function calculate() {
            const minutesLeft = getTimeLeftMinutes();
            const currentPoints = {};
            const pointsPerMinute = {};
            for (let i = 1; i <= 5; i++) {
                currentPoints[i] = parseInt(pointsInputs[i].value) || 0;
                pointsPerMinute[i] = 0;
            }

            const middleTeam = towerSelects.middle.value;
            if (middleTeam) pointsPerMinute[middleTeam] += TOWER_MIDDLE_RATE;

            [1,2,3,4].forEach(n => {
                const team = towerSelects[`crane${n}`].value;
                if (team) pointsPerMinute[team] += CRANE_RATE;
            });

            const teamCount = getActiveTeamsCount();
            const finalPoints = {};
            const activeTeams = [];
            for (let team = 1; team <= teamCount; team++) {
                finalPoints[team] = currentPoints[team] + pointsPerMinute[team] * minutesLeft;
                activeTeams.push(team);
            }

            checkVictory(currentPoints, minutesLeft);
        }

        // ==================== Victory Check ====================
        function checkVictory(currentPoints, minutesLeft) {
            const verdictDiv = document.getElementById('verdict');
            const P1 = currentPoints[1];

            const teamCount = getActiveTeamsCount();
            let Pmax = 0;
            for (let team = 2; team <= teamCount; team++) {
                if (currentPoints[team] > Pmax) Pmax = currentPoints[team];
            }

            if (teamCount < 2) { verdictDiv.innerHTML = ''; return; }

            const activeCranes = getActiveCranesCount();
            const totalRate = TOWER_MIDDLE_RATE + CRANE_RATE * activeCranes;
            const T = totalRate * minutesLeft;
            const neededExact = (Pmax + T - P1) / 2;
            const neededPoints = Math.floor(neededExact) + 1;

            const Tf = Math.floor(T).toLocaleString();
            const Nf = Math.floor(neededPoints).toLocaleString();

            if (neededPoints <= 0) {
                verdictDiv.innerHTML = `<div class="verdict win">${L.alreadyWin(Tf)}</div>`;
            } else if (neededPoints > T) {
                const deficit = Math.ceil(neededPoints - T).toLocaleString();
                verdictDiv.innerHTML = `<div class="verdict lose">${L.impossible(Tf, Nf, deficit)}</div>`;
            } else {
                const pct = Math.ceil((neededPoints / T) * 100);
                const minRate = (neededPoints / minutesLeft).toFixed(1);
                let hint;
                const mr = neededPoints / minutesLeft;
                if (mr <= CRANE_RATE) hint = L.hintCrane(CRANE_RATE);
                else if (mr <= TOWER_MIDDLE_RATE) hint = L.hintCenter(CRANE_RATE, TOWER_MIDDLE_RATE);
                else if (mr <= TOWER_MIDDLE_RATE + CRANE_RATE && activeCranes >= 1) hint = L.hintCenterCrane(TOWER_MIDDLE_RATE + CRANE_RATE);
                else hint = L.hintMulti(minRate);
                verdictDiv.innerHTML = `<div class="verdict need-action">${L.needCapture(Nf, Tf, pct, minRate, hint)}</div>`;
            }
        }

        // ==================== Optimizer ====================
        document.getElementById('optimizeBtn').addEventListener('click', function() {
            this.textContent = t('searching');
            this.disabled = true;
            setTimeout(() => {
                const result = findOptimalDistribution();
                showRecommendation(result);
                this.textContent = t('findStrategy');
                this.disabled = false;
            }, 100);
        });

        function calculateFinalPoints(config, currentPoints, minutesLeft, positions) {
            const ppm = { 1:0, 2:0, 3:0, 4:0, 5:0 };
            for (let i = 0; i < positions.length; i++) {
                const team = config[i];
                if (team) ppm[team] += positions[i] === 'middle' ? TOWER_MIDDLE_RATE : CRANE_RATE;
            }
            const fp = {};
            for (let team = 1; team <= 5; team++) {
                fp[team] = currentPoints[team] + ppm[team] * minutesLeft;
            }
            return { finalPoints: fp, pointsPerMinute: ppm };
        }

        function findAllWinningStrategies() {
            const cp = {};
            for (let i = 1; i <= 5; i++) cp[i] = parseInt(pointsInputs[i].value) || 0;
            const minutesLeft = getTimeLeftMinutes();
            const teamCount = getActiveTeamsCount();
            const enemyTeams = [];
            for (let t = 2; t <= teamCount; t++) enemyTeams.push(t);

            const activeCranes = getActiveCranesCount();
            const positions = ['middle'];
            for (let i = 1; i <= activeCranes; i++) positions.push(`crane${i}`);
            const rates = {};
            positions.forEach(p => { rates[p] = p === 'middle' ? TOWER_MIDDLE_RATE : CRANE_RATE; });

            const wins = [];

            function tryPos(t1pos) {
                const remIdx = [];
                for (let i = 0; i < positions.length; i++) { if (!t1pos.includes(i)) remIdx.push(i); }
                const sortedEnemies = [...enemyTeams].sort((a, b) => cp[b] - cp[a]);
                const sortedRem = [...remIdx].sort((a, b) => rates[positions[b]] - rates[positions[a]]);
                const cfg = new Array(positions.length).fill(null);
                t1pos.forEach(i => { cfg[i] = 1; });
                for (let i = 0; i < sortedEnemies.length && i < sortedRem.length; i++) {
                    cfg[sortedRem[i]] = sortedEnemies[i];
                }
                const { finalPoints, pointsPerMinute } = calculateFinalPoints(cfg, cp, minutesLeft, positions);
                const t1f = finalPoints[1];
                const maxOpp = Math.max(...enemyTeams.map(t => finalPoints[t] || 0));
                const diff = t1f - maxOpp;
                if (diff >= 1) {
                    const hasMiddle = t1pos.includes(0);
                    const craneCount = t1pos.length - (hasMiddle ? 1 : 0);
                    wins.push({ config: cfg, difference: diff, finalPoints, pointsPerMinute, positions, positionsUsed: t1pos.length, hasMiddle, craneCount, team1Positions: t1pos });
                }
            }

            const total = positions.length;
            for (let num = 0; num <= total; num++) {
                if (num === 0) {
                    const cfg = new Array(total).fill(null);
                    const se = [...enemyTeams].sort((a, b) => cp[b] - cp[a]);
                    for (let i = 0; i < se.length && i < total; i++) cfg[i] = se[i];
                    const { finalPoints, pointsPerMinute } = calculateFinalPoints(cfg, cp, minutesLeft, positions);
                    const diff = finalPoints[1] - Math.max(...enemyTeams.map(t => finalPoints[t] || 0));
                    if (diff >= 1) wins.push({ config: cfg, difference: diff, finalPoints, pointsPerMinute, positions, positionsUsed: 0, hasMiddle: false, craneCount: 0, team1Positions: [] });
                } else {
                    (function gen(start, cur) {
                        if (cur.length === num) { tryPos([...cur]); return; }
                        for (let i = start; i < total; i++) { cur.push(i); gen(i+1, cur); cur.pop(); }
                    })(0, []);
                }
            }

            const seen = new Set();
            const unique = wins.filter(s => {
                const key = `${s.hasMiddle?1:0}_${s.craneCount}`;
                if (seen.has(key)) return false;
                seen.add(key); return true;
            });

            unique.sort((a, b) => {
                if (a.positionsUsed !== b.positionsUsed) return a.positionsUsed - b.positionsUsed;
                if (a.hasMiddle !== b.hasMiddle) return a.hasMiddle ? 1 : -1;
                return b.difference - a.difference;
            });

            return unique;
        }

        function findOptimalDistribution() {
            const s = findAllWinningStrategies();
            return s.length > 0 ? s : null;
        }

        function getStrategyDescription(s) {
            if (s.positionsUsed === 0) return L.stratDoNothing;
            if (s.positionsUsed === 1) return s.hasMiddle ? L.stratCenter : L.stratOneCrane;
            if (!s.hasMiddle) return L.stratCranes(s.craneCount);
            return L.stratCenterCranes(s.craneCount);
        }

        function posName(p) {
            return p === 'middle' ? t('center') : `${t('craneN')} ${p.replace('crane','')}`;
        }

        // ==================== Show Recommendation ====================
        function showRecommendation(strategies) {
            const rec = document.getElementById('recommendation');

            if (!strategies || strategies.length === 0) {
                const T = Math.floor((TOWER_MIDDLE_RATE + CRANE_RATE * getActiveCranesCount()) * getTimeLeftMinutes()).toLocaleString();
                rec.innerHTML = `<div style="background:rgba(255,55,95,0.08);border-left:3px solid #ff375f;padding:15px;border-radius:4px;border:1px solid rgba(255,55,95,0.2);">${L.noWin(T)}</div>`;
                return;
            }

            let html = `<div><h3 style="margin:0 0 15px;color:#00e5ff;font-size:16px;text-transform:uppercase;letter-spacing:1px;">${L.winsTitle}</h3>`;

            strategies.forEach((s, idx) => {
                const diff = Math.floor(s.difference);
                const desc = getStrategyDescription(s);
                const t1r = s.pointsPerMinute[1];
                let maxER = 0;
                for (let t = 2; t <= 5; t++) { if (s.pointsPerMinute[t] > maxER) maxER = s.pointsPerMinute[t]; }
                const net = t1r - maxER;
                const best = idx === 0;

                html += `<div style="background:${best?'rgba(0,255,136,0.06)':'#0d1320'};border-left:3px solid ${best?'#00ff88':'#2a3545'};padding:14px;border-radius:4px;margin-bottom:10px;cursor:pointer;border:1px solid ${best?'rgba(0,255,136,0.2)':'#1e2a3a'};transition:border-color .2s;" class="strategy-option" data-index="${idx}">`;
                html += `<div style="font-size:15px;font-weight:700;color:${best?'#00ff88':'#c8d6e5'};">${best?'‚≠ê ':''}${desc}</div>`;

                html += '<div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px;">';

                // Team 1
                html += `<div style="background:#111827;padding:8px;border-radius:4px;border-left:2px solid #00ff88;">`;
                html += `<strong style="color:#00ff88;">${t('myTeam')}:</strong> <span style="color:#00e5ff;font-family:Menlo,Courier New,monospace;">+${t1r}/${t('min')}</span><br>`;
                if (s.positionsUsed === 0) {
                    html += `<span style="color:#5a6577;">${L.noPositions}</span>`;
                } else {
                    const myP = [];
                    s.positions.forEach((p, i) => { if (s.config[i] === 1) myP.push(posName(p)); });
                    html += `<span style="color:#8892a4;">${myP.join(', ')}</span>`;
                }
                html += '</div>';

                // Enemies
                html += `<div style="background:#111827;padding:8px;border-radius:4px;border-left:2px solid #ff375f;">`;
                html += `<strong style="color:#ff375f;">${L.enemies}:</strong><br>`;
                const ep = [];
                s.positions.forEach((p, i) => {
                    const tm = s.config[i];
                    if (tm && tm !== 1) {
                        ep.push(`${t('teamN')[0]}${tm}: ${posName(p)} <span style="color:#00e5ff;font-family:Menlo,Courier New,monospace;">(+${s.pointsPerMinute[tm]}/${t('min')})</span>`);
                    }
                });
                html += ep.length === 0 ? `<span style="color:#5a6577;">${L.noPositions}</span>` : `<span style="color:#8892a4;">${ep.join('<br>')}</span>`;
                html += '</div></div>';

                html += `<div style="margin-top:10px;padding:8px;background:#111827;border-radius:4px;font-size:13px;color:#8892a4;font-family:Menlo,Courier New,monospace;">`;
                html += `NET: <strong style="color:#00e5ff;">+${net}/${t('min')}</strong> ‚Üí ${lang === 'ru' ? '—Ä–∞–∑–Ω–∏—Ü–∞' : 'diff'}: <strong style="color:#00ff88;">+${diff}</strong> ${t('pts')}</div>`;
                html += '</div>';
            });

            html += '</div>';
            rec.innerHTML = html;

            document.querySelectorAll('.strategy-option').forEach(el => {
                el.addEventListener('click', function() {
                    const idx = parseInt(this.dataset.index);
                    const s = strategies[idx];
                    document.querySelectorAll('.strategy-option').forEach(o => { o.style.outline = 'none'; });
                    this.style.outline = '2px solid #00e5ff';
                    this.style.outlineOffset = '2px';
                    Object.values(towerSelects).forEach(sel => { sel.value = ''; });
                    s.positions.forEach((p, i) => { if (towerSelects[p]) towerSelects[p].value = s.config[i] || ''; });
                    calculate();
                });
            });
        }

        // ==================== Init ====================
        setLang(detectedLang);
        updateTeamVisibility();
        updateCraneVisibility();
        updateTimer();
        calculate();
    </script>
</body>
</html>
